# Comet API 確認手順（校歌・画像が出ないとき）

「HTML が返ったときの処理」は**クラッシュ防止だけ**です。**校歌や画像を出すには、Comet が正常に JSON/画像を返す状態にする必要があります。** 次を順に確認してください。

---

## 1. API キーを確認する

- **使っている環境変数**: `COMET_API_KEY`（校歌・画像・テキストで共通）
- **確認すること**:
  1. [Comet のダッシュボード](https://www.cometapi.com/)（または利用している Comet 系サービスの管理画面）にログインする
  2. API キー（API Key / Token）の一覧を開く
  3. 本番で使っているキーが **有効（Active）** か、**期限切れ・無効** になっていないか確認する
  4. キーをコピーし直し、Vercel の **Environment Variables** の `COMET_API_KEY` と**完全に一致**しているか確認する（前後にスペースが入っていないか、古いキーのままになっていないか）
- **変更した場合**: Vercel で保存したあと、**再デプロイ**する（環境変数はデプロイ時に取り込まれるため）

---

## 2. Suno（校歌）の利用可否を確認する

- **このアプリで使っているエンドポイント（2ステップ）**:
  1. **受付**: `POST https://api.cometapi.com/suno/submit/music` — ここに「こういう曲を作って」と送り、**task_id（受付番号）** だけが返る
  2. **受け取り**: **task_id** でタスク照会 API にポーリングし、完了したら音声 URL を取得（詳細は [CometAPI Suno 音楽生成仕様](./CometAPI_Suno_音楽生成_仕様.md) を参照）
- **確認すること**:
  1. Comet のサイト・ダッシュボードで **「Suno」「AI音楽」「音楽生成」** などのメニューや説明があるか探す
  2. 利用プランや契約内容に **Suno API / 音楽生成** が**含まれているか**を確認する
  3. 含まれていない場合は、**Suno が使えるプランに変更する**か、**Suno 用の有効化・追加契約**がないか案内を読む
  4. ドキュメントで **submit の URL**（`/suno/submit/music`）と **タスク照会（ポーリング）の URL** が変わっていないか確認する
- **補足**: 「HTML が返る」のは、認証エラー・未契約・エンドポイント違いなどで **エラーページ（HTML）** が返っている可能性が高いです。以前の誤ったエンドポイント（`/suno/generate`）は使わず、上記の2ステップで呼び出す。

---

## 3. 画像 API の利用可否を確認する

- **このアプリで使っている呼び出し**: `https://api.cometapi.com/v1beta/models/{モデルID}:generateContent`（例: `gemini-2.0-flash-exp-image-generation`）
- **確認すること**:
  1. Comet のサイト・ダッシュボードで **「画像生成」「Gemini Image」「Image Generation」** などのメニューや説明があるか探す
  2. 利用プランに **画像生成 API** が**含まれているか**を確認する
  3. **利用可能なモデル ID** の一覧があれば、次のどれかが載っているか確認する  
     - `gemini-2.0-flash-exp-image-generation`（このアプリのデフォルト）  
     - または `COMET_IMAGE_MODEL` に設定している値
  4. 含まれていない場合やモデル名が違う場合は、**画像が使えるプラン・モデル**に合わせて、Vercel の `COMET_IMAGE_MODEL` を変更する（または未設定ならデフォルトのまま運用）

---

## 4. レート制限・エラーを確認する

- **確認すること**:
  1. Comet のダッシュボードに **利用量・リクエスト数・エラーログ** の画面があれば開く
  2. **レート制限（Rate Limit）** に達していないか、**429 エラー** が出ていないか確認する
  3. **エラー一覧** があれば、**4xx / 5xx** や「認証エラー」「未対応 API」のようなメッセージが出ていないか確認する
  4. 校歌を多く生成した直後なら、**Suno の利用上限** に引っかかっていないかも確認する
- **対処**: レート制限なら時間をおいて再試行。契約・プラン起因なら、プラン変更や利用可能 API の確認が必要です。

---

## 5. このアプリ側で確認できること（ログ）

- すでに入れている **「HTML が返ったときの処理」** により、次のようなログが出ます：
  - **校歌**: `Suno API returned HTML instead of JSON` または `Suno API が HTML を返しました`
  - **画像**: `Comet image API returned HTML instead of JSON` または `Comet image API non-OK:`
- **Vercel の Logs** で上記を検索し、**同じ時刻に Comet 側のエラーや利用制限** が無いか照らし合わせると原因を絞りやすいです。

---

## まとめチェックリスト

| # | やること | 確認場所 |
|---|----------|----------|
| 1 | API キーが有効で、Vercel の `COMET_API_KEY` と一致している | Comet ダッシュボード ＋ Vercel Environment Variables |
| 2 | Suno（校歌）API が契約・プランに含まれている | Comet の料金・機能・ドキュメント |
| 3 | 画像生成 API（Gemini Image 等）が契約・プランに含まれている | Comet の料金・機能・ドキュメント |
| 4 | レート制限や 429 エラーが出ていない | Comet の利用量・エラーログ |
| 5 | 変更後は必ず **再デプロイ** する | Vercel |

**「HTML が返ったときの処理」はクラッシュ防止用**なので、上記を満たして Comet が **JSON（校歌）や画像を正常に返す**ようにすると、校歌・画像が表示されるようになります。
