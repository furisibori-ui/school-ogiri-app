# プロジェクト構造とサービス横断の概要

このプロジェクトがどういう構造で、どのサービス・設定を横断しているかをざっとまとめたドキュメントです。

---

## 1. ディレクトリ構成（押さえどころ）

```
school-ogiri-app/
├── app/                    # Next.js App Router
│   ├── page.tsx            # トップページ（状態・ポーリング・画面切り替え）
│   ├── HomeContent.tsx     # ランディング / 地図 / 学校サイトの表示切り替え
│   ├── layout.tsx, globals.css
│   ├── settings/           # 環境変数一覧の説明ページ
│   └── api/                # バックエンド API（下記）
├── components/
│   ├── MapSelector.tsx     # 地図・ピン・ランドマーク取得（Google Maps）
│   ├── LoadingScreen.tsx   # 生成中の「工事中」画面
│   └── SchoolWebsite.tsx   # 生成された学校サイトの表示
├── lib/
│   └── inngest/
│       ├── client.ts       # Inngest クライアント定義
│       └── functions/
│           └── school-generate.ts  # 学校生成のバックグラウンド処理（Step1〜4）
├── types/
│   └── school.ts          # SchoolData, LocationData などの型
├── docs/                   # 各種メモ・手順
└── vercel.json             # Vercel の関数タイムアウト等
```

- **フロント**: `app/page.tsx` が「地図でピン → ジョブ開始 → ポーリング → 学校表示」の流れを握っている。
- **バックグラウンド**: 実際の「テキスト→画像→校歌」は **Inngest** の `school-generate` が担い、各ステップで **API ルート** を内部で叩いている。
- **設定は環境変数** に集約され、API ごとに「どのキーがあればどのサービスを使うか」で分岐している。

---

## 2. ユーザーから見た流れ（1本の線）

1. **ランディング** → 「はじめる」で地図へ。
2. **地図**でピンを置く → その地点のランドマーク等を取得（Google Maps / Places）。
3. **「学校生成」** を押すと  
   - `POST /api/school/generate-job` で **Inngest にイベント送信** → **jobId** が返る。  
   - フロントは **`GET /api/job?jobId=xxx` をポーリング**。  
   - バックグラウンドで Inngest が **Step1（テキスト）→ Step2（画像）→ Step3（校歌）→ Step4（KV 保存）** を実行。  
   - `status: 'completed'` かつ `data` が返ったら **学校サイト画面** に切り替え。
4. **学校サイト** は `SchoolWebsite` が `SchoolData` をそのまま表示。画像・校歌の再取得などは同じ API を直接叩く場合あり。

つまり「**ジョブ開始 API → Inngest → 複数 API の連鎖 → 結果を KV に保存 → ポーリングで取得**」が 1 本の流れ。

---

## 3. 外部サービスと「どこで使うか」

| サービス | 役割 | 使っている場所 | 主な環境変数 |
|----------|------|----------------|----------------|
| **Comet** | テキスト（Claude 等）・画像（Gemini）・校歌（Suno 連携）の窓口 | `generate-school`, `generate-school-image`, `generate-audio` | `COMET_API_KEY`, `COMET_CHAT_MODEL`, `COMET_IMAGE_MODEL`, `COMET_IMAGE_USE_FLUX` |
| **Anthropic** | テキスト生成の代替（Comet が無いとき） | `generate-school`, `generate-school-anthem` | `ANTHROPIC_API_KEY` |
| **Replicate** | 画像生成（SDXL）・ロゴ（別モデル）の代替。設定されていれば画像は Comet ではなく Replicate | `generate-school-image` 内で `generate-image`, `generate-logo` を呼ぶ | `REPLICATE_API_TOKEN` |
| **Suno** | 校歌の音声生成。Comet 経由で利用 | `generate-audio`（Comet の Suno エンドポイント） | なし（Comet キーで完結） |
| **Google Maps / Places** | 地図表示・ピン位置のランドマーク取得 | `MapSelector.tsx`（フロントのみ） | `NEXT_PUBLIC_GOOGLE_MAPS_API_KEY` |
| **Vercel KV** | ジョブ状態・完了データ・Comet 成功モデルキャッシュ | `api/job`, Inngest の `school-generate`, `generate-school` | Vercel が Storage 連携で自動付与 |
| **Vercel Blob** | 画像の data URL をアップロードして URL 化（Inngest の 4MB 制限対策） | `generate-school-image` 内 | `BLOB_READ_WRITE_TOKEN`（Vercel Storage） |
| **Inngest** | 長時間の「学校生成」を Step に分けて実行・リトライ | `api/inngest/route.ts`, `api/school/generate-job`, `lib/inngest/functions/school-generate.ts` | Vercel と Inngest の連携（デプロイ時に設定） |

- **テキスト**: Comet 優先 → 失敗時やキーが無ければ Anthropic。  
- **画像**: Replicate が設定されていれば Replicate（`generate-image` / `generate-logo`）、なければ Comet（Gemini、または `COMET_IMAGE_USE_FLUX=true` で FLUX）。  
- **校歌**: Comet 経由の Suno のみ（別キー不要）。  

これらが「**環境変数の有無とフラグ**」で横断的に切り替わる構造になっている。

---

## 4. API ルート一覧と役割

| パス | 役割 | 主に使うサービス |
|------|------|------------------|
| `POST /api/school/generate-job` | ジョブ開始。Inngest に `school/generate` を送り、jobId を返す | Inngest |
| `GET /api/job?jobId=xxx` | ジョブ状態のポーリング。status と data（完了時）を返す | Vercel KV |
| `POST /api/generate-school` | 学校テキスト（JSON）を 1 回で生成。モック・修復・校歌フォールバックあり | Comet / Anthropic, KV（成功モデルキャッシュ） |
| `POST /api/generate-school-image` | 1 枚分の画像生成。prompt + imageType で校章・校舎・制服など | Comet（Gemini/FLUX） or Replicate + Blob |
| `POST /api/generate-image` | Replicate 用の汎用画像生成（generate-school-image から呼ばれる） | Replicate |
| `POST /api/generate-logo` | ロゴ画像（Replicate）。generate-school-image の logo 時に使用 | Replicate |
| `POST /api/generate-audio` | 校歌の音声 1 本。歌詞・タイトル・スタイルを渡す | Comet（Suno） |
| `POST /api/generate-school-anthem` | 校歌の「歌詞」だけ別生成する用（本番フローでは未使用の可能性） | Comet / Anthropic |
| `GET/POST /api/inngest` | Inngest の Webhook。登録した function がここで実行される | Inngest |

「学校生成」のメインの流れは、**generate-job → Inngest → generate-school → generate-school-image（複数回）→ generate-audio → KV に保存** という依存関係になっている。

---

## 5. Inngest の 4 ステップと保存先

`lib/inngest/functions/school-generate.ts` の 1 実行でやっていること：

| Step | 名前 | やること | 読む・書く場所 |
|------|------|----------|----------------|
| Step0 | set-running | ポーリング用に status を `running` に | KV: `school:${jobId}:status` |
| Step1 | text-and-anthem | `POST /api/generate-school` でテキスト生成 | KV: `school:${jobId}:partial` に途中保存 |
| Step2 | images | 校章・校舎・校長・銅像・制服・行事・部活の各 1 枚を `POST /api/generate-school-image` で生成し、結果を data にマージ | 同上（partial 更新） |
| Step3 | anthem-audio | `POST /api/generate-audio` で校歌 1 本取得し、data に追加 | 同上（partial 更新） |
| Step4 | save-kv | 完成した JSON を KV に保存し、status を `completed` に | KV: `school:${jobId}`, `school:${jobId}:status` |

- **KV のキー**: `school:${jobId}`（完了データ）, `school:${jobId}:status`, `school:${jobId}:partial`（途中）, `school:${jobId}:error`（失敗時）。  
- TTL は 1 時間で、その後は取得できなくなる。  
- フロントは **jobId** だけ持って `/api/job` を叩き、ここが KV を読んで status と data を返す。

---

## 6. 環境変数・設定のまとめ

- **必須（本番で学校生成を動かす）**  
  - `COMET_API_KEY` … テキスト・画像（Gemini）・校歌（Suno）に使用。  
  - Vercel KV / Blob 用の環境変数（Vercel ダッシュボードで Storage 連携すると付与される）。  
  - Inngest の連携（Vercel と Inngest の接続設定）。

- **オプション**  
  - `ANTHROPIC_API_KEY` … Comet が使えないときのテキスト用。  
  - `REPLICATE_API_TOKEN` … 画像を Replicate に切り替え（コスト・安定性用）。  
  - `COMET_CHAT_MODEL`, `COMET_IMAGE_MODEL`, `COMET_IMAGE_USE_FLUX` … Comet のモデル・画像エンジン切り替え。  
  - `NEXT_PUBLIC_GOOGLE_MAPS_API_KEY` … 地図・ランドマーク。  
  - `NEXT_PUBLIC_BASE_URL` … Inngest から API を叩くときのベース URL（未設定時は `VERCEL_URL` を使用）。

- **設定の効く範囲**  
  - ほぼすべて **Vercel の「Environment Variables」**（または `.env.local`）で制御。  
  - コード側は「キーやフラグの有無」で分岐しているだけなので、**どのサービスを使うかは設定の組み合わせで横断的に決まる**。

---

## 7. 複雑に感じるポイントの整理

- **1 回の「学校生成」が、Inngest の 4 ステップと複数 API にまたがっている**  
  - 流れを追うときは `generate-job` → `school-generate.ts` の Step 順に読むとよい。

- **テキスト・画像・校歌で「Comet / Anthropic / Replicate」が混在する**  
  - 上記の表のとおり「テキスト＝Comet or Anthropic」「画像＝Replicate or Comet」「校歌＝Comet（Suno）」と役割が分かれている。

- **保存先が「KV の jobId 紐づけ」だけ**  
  - 履歴一覧や「過去に戻す」は現状なく、**jobId 単位で 1 時間だけ**保持される設計。

- **フロントとバックグラウンドの境界**  
  - フロント: `page.tsx` のポーリング + `SchoolWebsite` の表示。  
  - バックグラウンド: Inngest が `getBaseUrl()` で自サイトの `/api/*` を叩く形で、**同じ Next.js の API をサーバーから呼んでいる**。

この 1 本の「ジョブ開始 → Inngest → 各 API → KV → ポーリング」を頭に入れておくと、どの設定がどこに効くかが追いやすくなる。

---

## 8. GitHub・Vercel・有料プラン・Blob・Inngest の組み方

「どこに何を置いて、どうつないでいるか」をインフラ寄りでまとめます。

### 全体のつながり（図のイメージ）

```
[GitHub]  ← ソースコードの置き場
    │
    │ push / マージでトリガー
    ▼
[Vercel]  ← ビルド＆ホスティング（Next.js が動く場所）
    │
    ├─ Serverless Functions（/api/* がここで動く）
    ├─ Vercel KV（Storage の 1 つ）← ジョブ状態・完了データ
    ├─ Vercel Blob（Storage の 1 つ）← 画像をアップロードして URL 化
    │
    │ デプロイ後の URL を Inngest に登録
    ▼
[Inngest]  ← バックグラウンドジョブの「指揮者」（Vercel の外のサービス）
    │
    │ Webhook で「この URL の /api/inngest を叩いて関数を実行」
    ▼
  再び [Vercel] の /api/generate-school などが呼ばれる
```

- **GitHub**: このリポジトリ（コードの唯一の置き場）。main などに push すると Vercel が自動でビルド・デプロイする前提。
- **Vercel**: Next.js のホスティング元。**API ルート（Serverless Functions）** もここで動く。KV と Blob は Vercel の **Storage** で「プロジェクトに紐づけて」使う。
- **Inngest**: 別サービス。Vercel にデプロイした **App URL**（例: `https://xxx.vercel.app`）を Inngest の「App」に登録し、**Sync** すると「このアプリの `/api/inngest` にいる関数一覧」を取得。ジョブ実行時は Inngest がその URL に **Webhook（POST）** を送り、Vercel 上で `school-generate` が動く。

### 各サービスの役割と「組み方」

| もの | 役割 | 組み方のポイント |
|------|------|------------------|
| **GitHub** | ソースのバージョン管理・共有。CI のトリガー元。 | Vercel のプロジェクトで「GitHub のこのリポジトリ」を接続。push → 自動デプロイ。 |
| **Vercel** | アプリ全体のホスティング＋API（Serverless）。 | 無料プランだと関数の実行時間に短い上限（例: 10 秒）がある。このアプリは **300 秒** まで使うので **Pro 等の有料プラン** が必要。 |
| **Vercel 有料プラン** | 関数の長時間実行（maxDuration: 300）や、ストレージを「プロジェクトに紐づけて」使うため。 | `vercel.json` と各 API の `maxDuration = 300` が効くのは、プランで 300 秒が許容されている場合。 |
| **Vercel KV** | キー・値ストア。jobId ごとの status や完成した学校 JSON を保存。 | Vercel ダッシュボードの **Storage** で KV を作成 → **Connect to Project** でプロジェクトに紐づけると、`KV_REST_API_*` が環境変数で入る。コードは `@vercel/kv` でアクセス。 |
| **Vercel Blob** | ファイル（画像）の保存。data URL をアップロードして公開 URL を返す。 | 同じく **Storage** で Blob を作成 → **Connect to Project** で紐づけると `BLOB_READ_WRITE_TOKEN` が入る。Inngest のステップ間 4MB 制限を避けるために「画像は Blob に上げて URL だけ渡す」ようにしている。 |
| **Inngest** | 長時間・多ステップのジョブを「イベント駆動」で実行・リトライ。 | 1) Inngest のサイトで App を作成し、App URL に **Vercel の本番 URL** を設定。2) Vercel の環境変数に `INNGEST_SIGNING_KEY`（と必要なら `INNGEST_EVENT_KEY`）を設定。3) デプロイ後に Inngest の **Sync** を実行して、`/api/inngest` から関数一覧を取得。以降、`inngest.send()` で送ったイベントに反応して、Inngest が Vercel の `/api/inngest` を叩き、`school-generate` が動く。 |

### 設定の流れ（初回 or 見直し時）

1. **GitHub** にリポジトリを置き、**Vercel** で「Import」してそのリポジトリを接続。
2. **Vercel** で **Pro 等の有料プラン** にし、**Storage** で **KV** と **Blob** を 1 つずつ作成し、**Connect to Project** で同じプロジェクトに紐づける。
3. **Inngest**（app.inngest.com）で App を作成し、App URL を Vercel の本番 URL に。Vercel の環境変数に Inngest の Signing Key を入れる。
4. **Comet** など他サービス用の API キーを Vercel の環境変数に追加（Production にチェックを忘れずに）。
5. デプロイ後、**Inngest の Sync** を実行。これで「GitHub → Vercel → 有料プラン＋KV＋Blob ＋ Inngest」の組み方が一通りそろう。
