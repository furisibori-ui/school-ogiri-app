# 学校生成 API のタイムアウト対応策

「処理が時間内に完了しませんでした（約1分）」が出る場合の原因と対応策です。

## 原因

- **Vercel の制限**: サーバーレス関数の実行時間に上限がある
  - **Hobby プラン（無料）**: 最大 **60 秒**（延長不可）
  - **Pro プラン（有料）**: 最大 **300 秒**（5 分）まで設定可能（当APIはその手前の290秒で打ち切り）
- `generate-school` API は Claude/Comet で長文の学校データを一括生成するため、60 秒を超えることがある
- **無課金（Hobby）のまま**だと、Vercel の 60 秒制限で 504 になるか、60 秒以内に完了するかのどちらかです。**Pro** の場合は 290 秒まで待ち、時間切れ時はモックで表示されその時点で確定（校章・画像の後から差し替えはなし）です。

---

## 対応策一覧

### 1. Vercel Pro で maxDuration を延長（推奨）

- **効果**: 最大 5 分まで待てるため、多くの場合で完了する
- **手順**:
  - Vercel を **Pro プラン**にアップグレード
  - 本リポジトリでは `vercel.json` と `app/api/generate-school/route.ts` の `maxDuration` を **300** に設定済み
  - Pro では 300 秒まで有効。Hobby のままでは 60 秒が上限のため変更は反映されない

### 2. 打ち切ってフォールバック（実装済み）

- **効果**: 時間切れとみなしてテンプレートデータ（モック）を返す
  - **Vercel Pro 利用時**: **290 秒**で打ち切り（maxDuration=300 を前提）
  - **Vercel Hobby 利用時**: 60 秒で Vercel に殺されるため、実質 60 秒以内に完了するか 504 になる
- **挙動**:
  - ユーザーには 504 ではなく **200** で学校データが返る
  - `fallbackUsed: true` と `errorMessage` が付くので、画面に「API が時間切れのためテンプレートで表示しています」などを出せる
  - **一度モックで返したら、校章・画像・テキストの追加修正・差し替えは行いません**（表示はそのまま確定）
  - 地元密着の凝った内容ではなくなるが、**エラー画面にはならない**

### 3. トークン数・入力の削減（実装済み）

- **効果**: 応答が早くなり、60 秒以内に収まりやすくなる
- **内容**:
  - `max_tokens` を 16384 → **8192** に変更（出力が長くなりすぎるのを抑制）
  - 地域リサーチ文は 1500 文字に制限済み

### 4. テキスト生成の並列化（現状と将来案）

- **現状**: **テキスト生成はすでに校歌（歌詞）API と並列**で走っています（`Promise.all` で学校API と 校歌API を同時開始）。遅いのは「学校テキスト1本」の処理時間そのもので、校歌が先に返ってもページは「両方そろうまで」表示されません。
- **地味に間に合っていない場合**: 学校API が 290 秒付近で打ち切られると、テキストもフォールバック（モック）になります。テキスト生成を間に合わせたい場合は、次が有効です。
- **将来案（パラレル分割）**: 学校テキストを **「コア」と「拡張」の2本に分割して並列実行**すると、それぞれが短くなり `max(コア, 拡張)` で済むため、1本で 290 秒ギリギリになるより完了しやすくなります。
  - 例: `generate-school-core`（校名・概要・校長・校訓・校章・校歌・銅像・制服・歴史的建物）と `generate-school-extended`（行事・部活・施設・教員）を `Promise.all` で同時に呼び、クライアントでマージする。
  - 未実装。設計時は「同じ地域コンテキストで2回叩くため、校名・地域の一貫性」に注意する。

### 5. 2 段階生成（未実装・別案）

- **概要**: 1 回目で「校名・概要・校訓・校長・校歌」だけ 60 秒以内に返し、2 回目で「行事・部活・施設・教員」などを別 API で取得する（順次実行）。
- **メリット**: 各リクエストを 60 秒以内に収めやすい
- **デメリット**: API が 2 本必要、クライアントの呼び出しが複雑になる

### 6. フォールバック時のメッセージ（実装済み）

- 打ち切った場合、API は `fallbackUsed: true` と `errorMessage` を返す（Pro 時は 290 秒で打ち切り）
- クライアントは `apiFallbackMessage` として表示しており、「⚠️ APIエラーのため… 生成が時間内に完了しませんでした（290秒）…」のように出る

---

## まとめ

| 対策 | 効果 | 備考 |
|------|------|------|
| Pro で maxDuration=300 | ◎ | 有料プラン必要。無課金 Hobby のままでは 55 秒でモック確定 |
| 290 秒でフォールバック（Pro） | ◎ | 504 を避けられる（実装済み） |
| max_tokens 削減 | ○ | 実装済み |
| テキスト＋校歌を並列（現状） | ○ | 学校API と 校歌API はすでに Promise.all で並列（実装済み） |
| テキストを2本に分割してパラレル（将来） | ○ | 要設計・実装。コア／拡張を同時に呼んでマージ |
| 2 段階生成（順次） | ○ | 要設計・実装 |

**Vercel Pro** 利用時は **290 秒**まで待ってからフォールバックするため、多くの場合で本物の校章・画像まで完了します。まずは Pro + maxDuration=300 の運用がおすすめです。

---

## 有料プランにしたら「絶対」一撃で生成できる？

**結論: ほぼ一撃で完了しやすくなりますが、「絶対」は保証できません。**

- **Pro にすると**: 関数の実行時間が **60 秒 → 最大 300 秒（5 分）** になるため、多くのピン・多くの地域で **1 回のリクエストで完了**しやすくなります。
- **「絶対」と言い切れない理由**:
  - モデル（Claude/Comet）の混雑時は応答が遅くなることがある
  - 地域リサーチが長い・プロンプトが重い場合は 5 分を超える可能性がゼロではない
  - ネットワークや API 側の一時エラーで失敗することもある
- そのため、**290 秒で打ち切ってフォールバック**する仕様にしてあり、時間切れ時はテンプレートデータで返すようにしています。
