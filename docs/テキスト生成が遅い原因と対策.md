# テキスト生成が遅い原因と対策

## なぜ 30 分でも終わらない？ 何が原因？

- **いちばん重いのはテキスト生成（Step1）**  
  `app/api/generate-school/route.ts` のシステムプロンプトは、**「100個連想」・細かい指示・長い成功例** がたくさん入っており、**入力トークン数が非常に多い**状態です。Claude がこれを読んで大きな JSON を返すまでに **数分〜十数分** かかっている可能性が高いです。
- **画像 7 枚**は並列なので、1 枚あたり 1〜2 分でも全体では 2 分前後でまとまることが多いです。
- **校歌 1 本**は Suno の混み具合によりますが、一曲で 2〜5 分程度が相場です。
- つまり **「30 分かかっても出ない」ときは、ほぼ Step1（テキスト）で時間を使っている**と考えてよいです。要約・大喜利指示がきついほど、モデルの処理が重くなります。

## 想定される原因（整理）

- **プロンプトが長く・複雑**  
  当初「テンプレのテキストを完成系」と想定して **「100個連想」・細かい指示・長い成功例** を多く入れているため、**入力トークン数が多く、モデルの処理時間が伸びている**可能性が高いです。
- 画像は並列で比較的短時間、楽曲も 1 本なので、**全体のボトルネックはテキスト生成（Claude への 1 回の長いリクエスト）** になりがちです。

## 対策の方向性

1. **プロンプトをシンプルなマークダウンに整理する**  
   - 必須項目だけを箇条書きや短い見出しで渡す。  
   - 「100個連想」や長い成功例は削るか、別ファイル（例: `docs/prompts/`）に切り出して、必要最小限だけ参照する。
2. **出力形式を固定する**  
   - JSON スキーマを短く示し、「このキーを必ず含む」程度に留める。  
   - 長い説明や複数パターンの例はプロンプトから外す。
3. **段階に分ける（将来の案）**  
   - まず「校名・校訓・概要だけ」を短いプロンプトで取り、そのあと「校歌」「行事」など別リクエストで足す、といった分割も検討できます。

## コード上の場所

- テキスト生成のメイン: **`app/api/generate-school/route.ts`**  
  - `systemPrompt` や `userPrompt` を組み立てている箇所が、長大なプロンプトの中心です。  
- 校歌のみ先行取得: **`app/api/generate-school-anthem/route.ts`**  
  - こちらは比較的短いので、重いのは主に `generate-school` 側です。

まずは **`generate-school` のプロンプトを短いマークダウン＋最小限の例に整理する** と、応答時間の改善が期待できます。

---

## 目安 10 分で出したいとき

- **制限時間**は 120 分に延長してあり、10 秒前には途中結果を表示するようにしてあります。
- **体感を 10 分前後にしたい**場合は、上記のとおり **テキスト用プロンプトの簡略化**が最も効きます。
- あわせて **Inngest の Run 詳細**で、Step1 / Step2 / Step3 のどれに何分かかっているかを確認すると、原因の切り分けがしやすくなります（Step1 が極端に長い＝プロンプト削減が有効）。
