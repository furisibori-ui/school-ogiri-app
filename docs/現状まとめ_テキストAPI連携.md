# 現状まとめ：テキストAPI連携まわり（共有用）

## このアプリでやっていること

- **学校大喜利アプリ**: 地図でピンを置くと、その場所をモチーフにした「架空の学校」を自動生成する。
- 生成するもの：
  1. **テキスト**（校名・校長挨拶・校歌歌詞・校訓・行事・部活など）← **ここが Comet のチャットAPI**
  2. **画像**（校章・校舎・校長の顔・創立者像・制服など 7 枚）← Comet の画像API（Gemini Image）
  3. **校歌の音声**（Suno 経由）← Comet の Suno 連携

- **API は Comet に一本化**している。使うキーは **COMET_API_KEY 1本だけ**。テキスト・画像・校歌すべてこのキーで叩いている。

---

## いま起きていること（テキストだけ 503）

- **画像**と**校歌**は、多くの場合問題なく動いている（Comet の画像API・Suno 連携は通る）。
- **テキスト生成だけ**、Comet のチャットAPIを呼ぶたびに **503** になり、  
  エラーメッセージは **「指定したモデルのチャネルが利用できません」「no available channel for group default and model ○○」** といった内容。
- その結果、テキストは **モック（フォールバック用のテンプレート）** が返り、画面には「⚠️ APIエラーのため、表示されているテキストはダミー（モック）です」と出る。

---

## 試しているモデルと「正しいID」の判明

**原因**: Comet API は **独自のモデルID形式** を使っている。  
`anthropic/claude-3-5-haiku` のような一般的な表記では「そんなチャネルはない」と 503 になる。  
Comet のドキュメント・サンプルコードに書いてある **model="○○"** をそのまま使う必要がある。

**例（Comet の Python サンプルより）**:  
- 一般的な表記: `anthropic/claude-3-5-haiku` → 503  
- Comet で有効な表記: **`claude-haiku-4-5-20251001`** → 接続可能な可能性が高い

テキスト生成では、次の順で **最大 6 個**までモデルを試している。

| 順番 | モデルID |
|------|----------|
| 1 | `claude-haiku-4-5-20251001` ← Comet サンプル形式（最優先） |
| 2 | `anthropic/claude-3-5-haiku` |
| 3 | `anthropic/claude-3-5-sonnet` |
| 4 | `google/gemini-2.5-flash` |
| 5 | `google/gemini-2.0-flash` |
| 6 | `openai/gpt-4o-mini` |

※ 過去に「前回成功したモデル」が KV に残っていれば、それを 1 番目に試す。  
※ ユーザーが **COMET_CHAT_MODEL** を設定している場合は、そのモデルを 1 番目に試す。

---

## なぜ「メジャーなのに全部ダメ」に見えるか（推測）

- **契約・プランでチャネルが有効になっていない**  
  Comet 側で「このアカウント／プランでは Claude や Gemini のチャネルがオフ」になっている可能性。
- **モデルIDの表記が違う**  
  実際に利用可能なIDが、`anthropic/claude-3-5-haiku` や `google/gemini-1.5-flash` ではなく、  
  バージョン付き（例: `google/gemini-1.5-flash-8b`）や別名の可能性。
- **グループやリージョン**  
  「group default」向けにそのモデルが割り当てられていない、などの設定の可能性。

いずれにしても、**Comet の管理画面・モデルカタログ・サポートで「このアカウントで利用可能なチャット用モデルID」を確認する**必要がある。

---

## こちらの対応状況（コード側）

- 複数モデルを **自動で順に試す**（上記 5 本 + ユーザー指定があればそれ優先）。
- **一度成功したモデル**を Vercel KV に 7 日間キャッシュし、次回はそのモデルを 1 番目に試す（無駄な 503 を減らす）。
- テキストが 503 のときは **モックを返し**、画像・校歌はそのモック内容で生成を続行（画像・校歌は出る）。
- モック表示時は、**画像・校歌のURLを KV に 30 日キャッシュ**して再利用し、API を節約。

---

## 共有したい「現状」の要約（Gemini などに貼るとき用）

- **アプリ**: 地図ピンから架空の学校を生成（テキスト・画像・校歌）。API は Comet に一本化（キー 1 本）。
- **現象**: テキスト生成だけ 503。「no available channel for group default and model ○○」。Claude（Haiku/Sonnet）・Gemini 1.5 を試したが同様。
- **疑問**: メジャーなモデルばかりなのに、このアカウントではすべて「チャネルが利用できません」になる理由が知りたい。
- **確認したいこと**: この Comet アカウント／プランで **実際に利用可能なチャット用モデルID** の一覧と、それらの正しい表記（例: `google/gemini-1.5-flash` でよいか、別名か）。

---

## 次にやること（Gemini の提案どおり）

1. **まずはコード側の対応済み**: 試す順番の 1 番目に **`claude-haiku-4-5-20251001`** を入れた。デプロイすればこの形式で Haiku を試す。
2. **まだ 503 なら**: Vercel の環境変数で **`COMET_CHAT_MODEL=claude-haiku-4-5-20251001`** を **明示的に設定** して Redeploy し、学校生成を試す。
3. **それでも 503 なら**: Comet のカタログで「Gemini 1.5 Flash」などの **サンプルコード** を開き、そこに書いてある **model="○○"** をコピーして `COMET_CHAT_MODEL` に設定して試す。

---

## 参照リンク

- Comet モデルカタログ: https://www.cometapi.com/ja/models/
- Comet コンソール: https://www.cometapi.com/console/token
- このリポジトリ内のメモ: `docs/テキスト生成をなんとか実現する.md` に手順あり。
