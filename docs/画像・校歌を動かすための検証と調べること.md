# 画像・校歌を動かすための検証と調べること

画像と校歌生成を「できるようにする」ための**検証項目**と、**Gemini・Comet ドキュメントで調べてほしいこと**をまとめています。自分で確認する項目と、AIやドキュメントに聞く項目を分けてあります。

---

## この出力から分かること（step2 の結果が placehold.co だけのとき）

保存されたデータに次のようなときは、**2つの問題**が起きている可能性があります。

| フィールド | 意味 |
|------------|------|
| `"errorMessage": "生成が時間内に完了しませんでした（290秒）。テンプレートデータで表示します。"` | **Step1（テキスト生成）が 290 秒でタイムアウト**した。AI の校歌・校訓・沿革などは生成されず、**テンプレート（モック）データ**が使われている。 |
| `"fallbackUsed": true` | 上記のとおり、テキストはフォールバック（テンプレート）である。 |
| すべての `image_url` / `emblem_url` / `face_image_url` が `placehold.co` | **Step2（画像生成）**で、`/api/generate-school-image` が**実画像の URL を返していない**。7 枚ともプレースホルダーに差し替えられている。 |

**やることの順番**

1. **290 秒タイムアウト（Step1）**  
   - テキストを短くする・プロンプトを軽くする（[290秒タイムアウト_どうするか.md](./290秒タイムアウト_どうするか.md) 参照）。  
   - または「テンプレートでもよい」ならそのまま運用し、**画像・校歌だけ**を直す。
2. **画像が全部 placehold.co（Step2）**  
   - Inngest の Run で step2 のログを確認 → `realImages: 0`, `placeholderImages: 7` なら画像 API がすべて失敗。  
   - Vercel Logs で `Comet image` または `generate-school-image` を検索し、[画像・校歌が出ないときの確認手順.md](./画像・校歌が出ないときの確認手順.md) の表と照合する。

校歌（Step3）は、このデータでは `school_anthem.audio_url` が無いため「校歌の音声が生成されていません」と表示されます。Step3 のログに `step3: no audio URL` が出ていれば Suno 側の失敗です。

### step3 の出力で `school_anthem.audio_url` が無いとき

| 見る場所 | 意味 |
|----------|------|
| `school_anthem` に `lyrics` / `title` / `style` はあるが **`audio_url` が無い** | **Step3（校歌音声）**で `/api/generate-audio`（Suno）が音声 URL を返していない。 |
| Inngest の step3 ログに **`step3: no audio URL`** | 同上。Suno の submit またはポーリングで失敗している。 |

**確認すること**

- Vercel Logs で該当時刻に **`Suno`** または **`generate-audio`** を検索する。
- 出ているログの種類で切り分け（[画像・校歌が出ないときの確認手順.md](./画像・校歌が出ないときの確認手順.md) の「3. 校歌が出ない場合」の表を参照）:
  - `Suno submit returned HTML` / `Suno API が HTML を返しました` → 認証・プラン・エンドポイント
  - `Suno submit のレスポンスに task_id が含まれていません` → レスポンス形式の違い
  - `Suno poll timeout` → ポーリングが完了までに至らなかった
  - `Suno task failed` → タスクが失敗で返った

---

## 第一部：自分でできる検証（チェックリスト）

### A. 環境・設定の確認

| # | 検証内容 | 確認方法 | 参照 |
|---|----------|----------|------|
| 1 | API キーが有効で Vercel と一致している | Comet ダッシュボードでキーを確認 → Vercel の `COMET_API_KEY` と完全一致（前後スペースなし） | [Comet_API_確認手順.md](./Comet_API_確認手順.md) |
| 2 | 画像は Comet か Replicate か | `REPLICATE_API_TOKEN` があると画像は **Replicate** になる。Comet の画像ログは出ない | 環境変数一覧を確認 |
| 3 | 画像モデル ID が契約と一致している | Comet の「利用可能モデル」に `gemini-2.0-flash-exp-image-generation` または `COMET_IMAGE_MODEL` の値があるか | Comet 料金・ドキュメント |
| 4 | Suno（音楽生成）がプランに含まれているか | Comet の料金・機能ページで「Suno」「音楽生成」が有効か | Comet ダッシュボード |
| 5 | 変更後に再デプロイしたか | 環境変数を変えたら必ず再デプロイ | Vercel |

### B. 失敗箇所の切り分け（実行後）

| # | 検証内容 | 確認方法 |
|---|----------|----------|
| 6 | 画像が全部失敗か・校歌だけか | Inngest の Run を開く → step2 の `realImages` / `placeholderImages`、step3 の `step3: no audio URL` の有無を確認 | [画像・校歌が出ないときの確認手順.md](./画像・校歌が出ないときの確認手順.md) |
| 7 | どのログが出ているか | Vercel Logs で該当時刻に `Comet image` または `Suno` で検索し、表のキーワードと照合 | 同上 |

### C. 動作確認用の最小テスト（任意）

- **画像だけ試す**: フロントや Postman から `POST /api/generate-school-image` に `{ "prompt": "A simple red apple on white background", "imageType": "overview" }` を送り、`url` が placehold.co 以外（Blob URL や data URL）で返るか。
- **校歌だけ試す**: `POST /api/generate-audio` に `{ "lyrics": "テスト\n一行目", "title": "Test", "style": "calm" }` を送り、`url` が null でないか。Vercel Logs に `[Suno Submit]` / `[Suno Fetch]` が出るか。

---

## 第二部：Gemini・Comet ドキュメントで「調べてほしい」こと

以下を **Gemini に聞くとき** や **Comet 公式ドキュメントを読むとき** の質問・確認リストとして使ってください。

---

### 画像生成（Comet + Gemini Image）

1. **Comet 経由で Gemini 画像生成を使うとき**
   - 利用可能な**画像生成用モデル ID** の一覧は？（例: `gemini-2.0-flash-exp-image-generation`, `gemini-2.5-flash-image` が Comet で使えるか）
   - 画像生成 API は**無料枠・クレジット**で使えるか、有料プランのみか。
   - **安全フィルタでブロックされやすいプロンプト**の例と、ブロックを避ける書き方（英語のプロンプトで避けるべき単語・表現はあるか）。

2. **「200 OK だが画像が返ってこない」場合**
   - レスポンスの `candidates` が空、または `finishReason` が SAFETY 等になるとき、**公式にはどのフィールドで理由が分かるか**（`finishReason` の取りうる値一覧）。
   - ブロックされにくい**短く安全な画像プロンプトの例**（校舎・人物・銅像など、このアプリで使うような題材）。

3. **エンドポイント・認証**
   - Comet で画像生成を有効にするために、**ダッシュボード側で「画像生成」や「Gemini Image」を有効化するスイッチ**はあるか。
   - 同じ `COMET_API_KEY` で**テキスト（Chat）は成功するが画像だけ失敗する**場合、考えられる原因は何か（権限・プラン・モデル ID の違いなど）。

---

### 校歌生成（Comet + Suno）

4. **Submit のリクエスト形式**
   - `POST https://api.cometapi.com/suno/submit/music` の**必須パラメータ**は何か（`prompt` 以外に `title`, `tags`, `mv`, `make_instrumental` などは必須か任意か）。
   - **歌詞だけ**で曲を生成する場合、`prompt` には歌詞全文を入れてよいか、それとも「スタイル説明＋歌詞」のようにフォーマットがあるか。
   - `mv`（モデルバージョン）に `chirp-v4` / `chirp-auk` / `chirp-bluejay` を指定したときの**違い**（料金・品質・対応しているか）。

5. **Submit のレスポンス**
   - 成功時に返る **`task_id` の正確なフィールド名**は何か（`task_id`, `id`, `data.task_id` のどれか、または別名）。
   - 失敗時（400/401/403/500）の**レスポンス body の形式**（エラーメッセージやコードがどこに入るか）。

6. **タスク照会（ポーリング）**
   - タスク照会の**正しい URL** は次のどれか（または別の形式か）。
     - `GET https://api.cometapi.com/suno/fetch?task_id={task_id}`
     - `GET https://api.cometapi.com/suno/fetch/{task_id}`
     - その他（例: `POST /suno/task/query` に body で `task_id`）
   - 完了時に**音声 URL が入るフィールド名**は何か（`audio_url`, `url`, `stream_url`, `data.audio_url` など）。
   - 処理中・完了・失敗を表す **`status` の値**の一覧（`pending`, `running`, `complete`, `success`, `failed` 等、正式な文字列）。

7. **運用・制限**
   - 1 曲あたりの**目安の生成時間**（何秒〜何分か）。ポーリング間隔は何秒が推奨か。
   - **レート制限**（1 分あたりのリクエスト数や、同時タスク数）の有無と目安。
   - Suno が**利用可能なプラン**の名前（無料トライアルで使えるか、有料のみか）。

---

## 第三部：Gemini にそのまま渡せる「質問文」の例

コピペして Gemini に聞くときの例です。

---

**（画像用）**
```
CometAPI 経由で Gemini の画像生成 API（generateContent, responseModalities: ["IMAGE"]）を呼んでいますが、
200 OK で JSON が返るのに candidates[0].content.parts に inlineData が入らず、画像が取れません。
- Comet で使える画像生成モデル ID の一覧と、無料/有料の区別を教えてください。
- 安全フィルタでブロックされるとき、レスポンスのどのフィールドで理由が分かりますか？ finishReason の取りうる値は？
- 校舎・校長の肖像・銅像のような「学校サイト用」の画像で、ブロックされにくい英語プロンプトの書き方の例を教えてください。
```

---

**（校歌用）**
```
CometAPI の Suno 音楽生成で、POST /suno/submit/music でタスクを送り、GET /suno/fetch?task_id=xxx でポーリングする実装をしています。
- submit の必須パラメータ（prompt 以外）と、成功時に返る task_id の正確なフィールド名を教えてください。
- タスク照会の正しい URL は GET /suno/fetch?task_id= でよいか、それとも /suno/fetch/{task_id} など別形式か。
- 完了時に音声 URL が入るレスポンスのフィールド名（audio_url, url, stream_url 等）と、status の値（pending, complete, success 等）の一覧を教えてください。
- 歌詞のみで曲を生成する場合、prompt には歌詞全文をそのまま入れてよいか、フォーマットの指定はありますか。
```

---

## 第四部：まとめ

- **まず** 第一部の A・B を自分で確認し、**どこで失敗しているか**（画像だけ / 校歌だけ / 両方）と **どのログが出ているか** を把握する。
- **次に** 第二部の項目を、Comet の公式ドキュメントまたは Gemini に「CometAPI の仕様として」聞く。第三部の質問文をそのまま使ってもよい。
- 分かったこと（正しい URL・フィールド名・必須パラメータ）は、[CometAPI_Suno_音楽生成_仕様.md](./CometAPI_Suno_音楽生成_仕様.md) や [Gemini画像API_マニュアルで確認すること.md](./Gemini画像API_マニュアルで確認すること.md) にメモし、必要ならコード（`generate-audio` / `generate-school-image`）を修正する。

原因が「認証・プラン・モデル ID」のどれに近いかが分かれば、対処の優先順位が付けやすくなります。
