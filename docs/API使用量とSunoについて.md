# API 使用量と Suno について

## テキスト・画像が「テンプレっぽい」「毎回似た内容」になる場合

- **原因**: 学校テキスト生成（Claude 経由）が失敗し、**モック（フォールバック）データ**が返っているためです。画像はそのモック内容で生成されるため、パターンが似ます。
- **対処**:
  1. **Comet のチャットモデル**: エラーに「指定したモデルのチャネルが利用できません」と出る場合、**Vercel の環境変数**を確認します。`.env.local` はローカル専用なので、本番は **Vercel ダッシュボード → プロジェクト → Settings → 環境変数** で設定します。
  2. **`COMET_CHAT_MODEL` がもともとない場合**: コードはデフォルトで `anthropic/claude-3-5-haiku` → 失敗時のみ `anthropic/claude-3-5-sonnet` を試します。両方「チャネルが利用できません」なら、**Comet の契約・プランでそのモデルが使えない**可能性があります。そのときは下記「Comet チャットモデル設定の概要」のとおり、**利用可能なモデルID を確認してから、Vercel に `COMET_CHAT_MODEL` を「追加」**してください（他の環境変数と同じように、キーと値を登録するだけです）。
  3. **一度だけ成功したことがある**: Comet 側のチャネル空きや負荷で、同じモデルが「使えるとき」と「使えないとき」がある場合があります。安定させたい場合は、Comet のモデルカタログで **自分のプランで確実に使えるモデルID** を選び、`COMET_CHAT_MODEL` にその ID を設定するのがおすすめです。

---

## Comet チャットモデル設定の概要（COMET_CHAT_MODEL）

- **登録場所**: **Vercel** の環境変数（ローカルだけの `.env.local` ではなく、本番用は Vercel の「環境変数」に追加）。画像で見ている「環境変数」一覧に、**新規でキー `COMET_CHAT_MODEL`、値にモデルID** を追加すればOKです。
- **利用可能なモデルIDの確認**:
  - Comet の **モデルカタログ**: [https://www.cometapi.com/ja/models/](https://www.cometapi.com/ja/models/) で 500 以上のモデルと **モデルID** を確認できます。
  - ダッシュボード: [https://www.cometapi.com/console/token](https://www.cometapi.com/console/token) で API キー・使用状況を管理。
  - ドキュメント: [https://apidoc.cometapi.com/](https://apidoc.cometapi.com/) でエンドポイントやモデル名を確認可能。
- **モデルIDの例**（Comet の仕様により表記が異なる場合があります）:
  - Claude 系: `anthropic/claude-3-5-haiku` / `anthropic/claude-3-5-sonnet` のほか、`claude-sonnet-4-5-20250929` などバージョン付きの形式もあることがあります。**実際に使う値はモデルカタログまたは料金ページの表記に合わせてください。**
  - 契約によっては「Haiku は使えるが Sonnet は使えない」などチャネルが限られることがあり、その場合は **カタログで利用可能と書いてあるモデルID** を `COMET_CHAT_MODEL` に設定します。
- **まとめ**: 「no available channel」「model_not_found」が出たら、Comet のモデルカタログで **自分のプランで利用可能なモデルID** を確認し、その ID を Vercel の環境変数 **`COMET_CHAT_MODEL`** に追加（キー・値とも画像の他の変数と同じように登録）すれば、その 1 本で学校生成が動くようになります。

## 1回の「学校生成」でどれくらい消費するか・何円か

- **「Application error」や画面真っ白は「お金が足りない」サインではありません。** クライアント側の JavaScript エラー（データ未定義など）のことが多いです。料金不足なら Comet の API が 402/403 等を返し、画面には「APIエラー」系のメッセージが出ます。
- **1回の学校生成で呼ばれるもの**: テキスト（Claude 系 1回）、**画像（7〜8枚：校章・初代校舎・現校舎・校長・銅像・制服・行事1・部活1）**、校歌（Suno 1回）。Comet 経由なので **COMET_API_KEY 1本** でこれらがすべて消費されます。
- **「2回しかやってないのになぜこんなに？」**  
  **1回の学校生成 ＝ 画像を 7〜8 枚分リクエスト** します。なので **2回やると 14〜16 回の画像API呼び出し**になります。画像生成（FLUX 2 FLEX や Gemini Image）は 1 枚あたり数セントかかるため、2回で **$0.2〜0.4 程度**になるのは想定内です。**実行回数より「画像の枚数」で課金が積み上がります。**
- **画像がエラー（プレースホルダー）になっても課金される？**  
  はい。create リクエストを送った時点で課金されることが多いです。エラーで画像が返ってこなくても、その 1 回分は消費として計上されます。
- **1回あたりの金額**: Comet の料金はプラン・モデルごとに違うため、**Comet ダッシュボード** [https://www.cometapi.com/console/token](https://www.cometapi.com/console/token) の **使用ログ（Usage Log）・請求・利用状況** で確認してください。使用分布で「チャット」「画像（flux-2-flex など）」「Suno」の増分を見れば、1回あたりの消費量の目安が分かります。
- 正確な「〇〇円/回」は Comet の料金表（単価）× 使用ログのリクエスト数で計算する必要があります。

## Comet の「使用分布」に Suno が出ない理由

Comet の API 使用概要（使用分布）には、**チャット補完（Claude）** や **画像生成（Gemini Image）** のような「標準的な Comet API エンドポイント」の呼び出しだけが集計されます。

- **Suno** は Comet の **別枠の連携**（`/suno/generate` など）で提供されているため、**同じ「使用分布」の円グラフには含まれない**ことがあります。
- 請求や利用量は、Comet のダッシュボードの **別のタブ・別のページ**（例: Suno 用の利用量）で確認する必要がある場合があります。

つまり「Suno がここに表示されていない」のは、**未使用だからではなく、集計の区分が違う**可能性が高いです。Comet の料金・利用状況のページで Suno や「音楽生成」の項目を探してみてください。

## Suno は別 API キー不要（Comet 経由）

- **Suno 用の API キーは不要**です。校歌生成は **Comet の Suno 連携**（`/suno/submit/music` と `/suno/fetch/{taskId}`）を使っているため、**COMET_API_KEY 1本**でテキスト（Claude）・画像（Gemini）・校歌（Suno）のすべてが動きます。Suno 専用の環境変数はありません。

## 校歌（Suno）が生成されない・「no audio URL」・ポーリングタイムアウト

- **step3: no audio URL** / **Suno ポーリングタイムアウト**: 校歌生成は「タスク送信 → 照会を最大60秒ポーリング」で行っています。Suno 側の混雑や遅延で 60 秒以内に完了しないと、音声 URL が取れず校歌が出ません。
- **ログに `status: "SUCCESS"` と `audio_url` が出ているのに校歌が出ない場合**: Comet のレスポンスが `data.data` 配列の中に `audio_url` を返す形のため、そのネストを正しく読む処理を入れています。デプロイ後に再試行してください。
- **対処**: 時間をおいて再度「学校生成」を試す。Comet の Suno fetch が **日本語キー**（`データ`・`ステータス`）で返す場合や、`data.data` 配列で clip が返る場合にも対応済みです。
- ログで `IN_PROGRESS` のまま 60 秒で打ち切られる場合は、Suno の処理が遅いだけなので再試行で成功することがあります。

## しばらく経つと校歌が聴けなくなる（システムアップデートのせいではない）

- **原因**: Comet / Suno から返ってくる**音声のURLは一時リンク**です。**十数分〜20分程度で期限切れになることもあり**、同じURLでは再生できなくなります。**システムアップデートやアプリの不具合ではありません。**
- **対処**: 校歌セクションの「**音声生成を再試行**」ボタンで、同じ歌詞で再度生成すると新しいURLが取得でき、また聴けるようになります。再生しようとしてエラーになったときも、同じメッセージと再試行ボタンが表示されます。
- 恒久的に聴けるようにするには、取得した音声を自前のストレージ（例: Vercel Blob）に保存する実装が必要です（現状は未対応）。

---

## ログから分かる「今の状態」の整理

| 現象 | 原因 | 対処 |
|------|------|------|
| テキストがテンプレ・モックで返る | **Comet の Claude（Haiku/Sonnet）が 503「チャネルが利用できません」**。契約上そのモデルが使えないか、一時的に使えない状態。 | Comet のモデルカタログで **利用可能なモデルID** を確認し、Vercel の `COMET_CHAT_MODEL` にその ID を設定する。Haiku も Sonnet も 503 なら、**別のモデル**（例: Gemini 系など Comet で使えるもの）を指定する必要あり。 |
| 画像が出ない / 校歌が出ない | テキスト生成が失敗してモックになっていると、Step2・Step3 はモックデータで進む。そのうえで **校歌だけ**「no audio URL」になることがある。 | 上記でテキストを直すと画像も校歌も流れが通る。校歌だけ問題のときは、Suno の **SUCCESS レスポンスから audio_url を確実に取る**処理が入っているので、最新コードをデプロイして再試行。 |
| Suno は API 設定要る？ | **不要**。Comet 経由なので **COMET_API_KEY のみ**で Suno も利用される。 | 追加の Suno 用環境変数は不要。 |
| Inngest の Step1 が約1秒で終わる | テキスト生成APIが **503 等で失敗しモックを返した**場合、API がすぐ返るため Step1 が約1秒で完了する。**本当にAIが生成した場合は十数秒〜数分**かかることもある。 | 画面上部に「⚠️ APIエラーのため、表示されているテキストはダミー（モック）です」と出ていればモック表示。出ていなければその回は正常生成。 |
| google/gemini-1.5-flash も 503 になる | Comet のモデルIDが違う可能性（例: バージョン付き）。契約でそのチャネルが無効な場合もある。 | Comet のモデルカタログで **利用可能と表示されているモデルID** をコピーし、`COMET_CHAT_MODEL` にそのまま設定する。 |

## 画像がエラーになる・消費を抑えたい場合

- **Comet 利用時の画像はデフォルトで Gemini Image（gemini-2.5-flash-image）** に戻しています。以前「普通に使えていた」のはこの Gemini 画像です。FLUX 2 FLEX がエラーになる場合は、環境変数 **`COMET_IMAGE_USE_FLUX`** を設定しなければ Gemini が使われます。
- **FLUX 2 FLEX を使いたい場合**  
  環境変数 **`COMET_IMAGE_USE_FLUX=true`** を設定すると、Comet の画像が FLUX 2 FLEX に切り替わります。FLUX のレスポンス形式や認証で失敗しているときは Vercel のログに `[FLUX]` が出ます。**エラーでも create リクエストは送っているため、課金は発生します。**
- **コストを抑えつつ安定させたい**  
  **REPLICATE_API_TOKEN** を設定すると、画像は **Replicate（SDXL）** で生成され、**Comet の画像API（Gemini / FLUX）は呼ばれません**。Replicate は 1 枚あたり約 0.3〜1 円程度で、2 回の学校生成（14〜16 枚）でも数百円程度に収まります。設定方法は下記「画像生成を安くする」を参照。

## 画像生成を安くする（画像API消費を抑える）

| 方法 | 効果 | やり方 |
|------|------|--------|
| **Replicate を有効にする（推奨）** | **約0.3〜1円/枚**。Comet の Gemini 画像（約6円/枚）より大幅に安い。 | **`REPLICATE_API_TOKEN`** を Vercel と `.env.local` に設定するだけ。設定すると画像は自動で Replicate（SDXL）に切り替わり、Comet の画像APIは使われません。詳しくは [SETUP_IMAGE_GENERATION.md](../SETUP_IMAGE_GENERATION.md)。 |
| Comet のまま使う | 現状のまま。 | `COMET_API_KEY` のみで、Replicate を設定しなければ Comet の **gemini-2.5-flash-image** が使われます。 |
| Comet で別モデルを試す | プランによっては別モデルの方が安い場合あり。 | 環境変数 **`COMET_IMAGE_MODEL`** に、Comet のモデルカタログで「画像生成」対応かつ料金の安いモデルIDを指定。 |

- **1回の学校生成で最大7〜8枚**の画像が生成されるため、Replicate にすると **1回あたり数円程度**、Comet のみだと **数十円程度** になる目安です。

## 画像生成のモデル（Comet 利用時）

- **デフォルトは Gemini Image（gemini-2.5-flash-image）**。以前「普通に使えていた」画像はこれです。環境変数 **`COMET_IMAGE_MODEL`** で別の Comet 画像モデルに変更できます。
- **FLUX 2 FLEX を使う場合**は **`COMET_IMAGE_USE_FLUX=true`** を設定します（デフォルトは未設定＝Gemini）。
- **Replicate**（`REPLICATE_API_TOKEN`）を設定すると、画像は Replicate 側で生成され、Comet の画像 API は使われません（コスト削減の選択肢になります）。

## 「出力が大きすぎる」で Inngest が失敗する場合

- Inngest のステップには **戻り値のサイズ制限（約 4MB）** があります。画像を **data URL（base64）** のまま Step2 の戻り値に含めると、7 枚で簡単に超えて **「出力が大きすぎる」** で失敗します。
- 対処：**Vercel Blob** を有効にし、環境変数 **`BLOB_READ_WRITE_TOKEN`** を設定してください。画像生成 API が data URL を返す場合、自動で Blob にアップロードし、**短い公開 URL だけ**を返すようにしています。これで Step 間で渡すデータが小さくなり、制限内に収まります。
- Vercel ダッシュボード → プロジェクト → **Storage** → **Create Database** で Blob を作成し、**Connect to Project** でプロジェクトに紐づけるとトークンが付与されます。
