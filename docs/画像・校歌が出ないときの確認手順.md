# 画像・校歌が出ないときの確認手順

「画像または校歌の音声が生成されていません」と出る場合、**画像 API または校歌（Suno）API のどちらか（または両方）がプレースホルダーを返している**状態です。次の順で原因を絞り込んでください。

---

## 1. Inngest の Run ログで「どこまで成功したか」を見る

1. [Inngest Dashboard](https://app.inngest.com/) にログインする。
2. 対象の環境（Vercel にデプロイしている場合はその Inngest アプリ）を開く。
3. **Runs** から、失敗した「学校生成」の Run を開く。
4. **step2-images** のログを確認する：
   - `step2 done` のあとに **`realImages: 0`** かつ **`placeholderImages: 7`** なら、**画像が1枚も生成されていない**（画像 API 側の失敗）。
   - `realImages: 7` なら画像は成功。校歌側を疑う。
5. **step3-anthem-audio** のログを確認する：
   - **`step3: no audio URL`** と出ていれば、**校歌音声の取得に失敗している**（Suno / generate-audio 側の失敗）。
   - **`step3 done` `hasAudio: true`** なら校歌は成功。

**ポイント:** Inngest のログで「画像が全部プレースホルダー」か「校歌だけ失敗」かを切り分ける。

---

## 2. 画像が出ない場合（step2 で realImages: 0）

**Vercel → Logs** で、該当時刻あたりに次のいずれかが出ていないか検索する：

| ログに含まれる文言 | 意味 | 対処 |
|--------------------|------|------|
| `Comet image API returned HTML` | Comet が HTML（エラーページ）を返した | 認証エラー・未契約・エンドポイント不一致の可能性。[Comet_API_確認手順.md](./Comet_API_確認手順.md) の 1〜3 を確認。 |
| `Comet image API non-OK:` | 4xx/5xx が返った | Comet ダッシュボードでエラー内容・レート制限を確認。 |
| `Comet image API response not JSON` | レスポンスが JSON ではなかった | 上と同様、Comet 側の返却を確認。 |
| `[Comet image] 200 OK but no image` | 200 だが画像データが無い | 安全フィルタでブロックされている可能性。プロンプト内容や `COMET_IMAGE_MODEL` の変更を検討。 |

- **REPLICATE_API_TOKEN** を設定している場合は、画像は **Replicate** 経由になる。その場合は Comet のログは出ず、Replicate 側のエラーを疑う。
- 環境変数で **COMET_API_KEY** と **REPLICATE_API_TOKEN** のどちらが設定されているか確認する（Replicate 優先）。

---

## 3. 校歌が出ない場合（step3 で no audio URL）

**Vercel → Logs** で、該当時刻あたりに次のいずれかが出ていないか検索する：

| ログに含まれる文言 | 意味 | 対処 |
|--------------------|------|------|
| `Suno submit returned HTML` / `Suno API が HTML を返しました` | Comet Suno が HTML を返した | [Comet_API_確認手順.md](./Comet_API_確認手順.md) の 1〜2。Suno 利用可否・API キーを確認。 |
| `Suno submit のレスポンスに task_id が含まれていません` | タスク受付のレスポンス形式が想定と違う | Comet の Suno submit ドキュメントでレスポンス形式を確認。[CometAPI_Suno_音楽生成_仕様.md](./CometAPI_Suno_音楽生成_仕様.md) の task_id の取り方を見直す。 |
| `Suno poll timeout` | ポーリングで完了までに至らなかった | Suno 側の遅延・障害。時間をおいて再試行。必要ならポーリングのタイムアウトを延長。 |
| `Suno task failed` | タスクが失敗扱いで返った | ログの生レスポンスを確認し、Comet のエラー内容に合わせて対処。 |

---

## 4. まとめ

1. **Inngest の Run** で `step2` / `step3` のログを見て、**画像が全部プレースホルダーか**・**校歌の URL が取れていないか**を判断する。
2. **Vercel Logs** で上記のキーワードを検索し、Comet / Replicate / Suno のどの段階で失敗しているかを確認する。
3. 認証・プラン・レート制限は [Comet_API_確認手順.md](./Comet_API_確認手順.md) のチェックリストで確認する。

原因が分かったら、該当する API の設定・契約・プロンプトを見直し、再度「学校生成」を実行してください。
