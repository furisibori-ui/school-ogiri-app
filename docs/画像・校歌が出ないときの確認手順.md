# 画像・校歌が出ないときの確認手順

「画像または校歌の音声が生成されていません」と出る場合、**画像 API または校歌（Suno）API のどちらか（または両方）がプレースホルダーを返している**状態です。次の順で原因を絞り込んでください。

---

## 0. これからやること（Inngest は「成功」なのに画像・校歌が出ない場合）

**処理は始まっているし、Inngest でも成功と出ている。でも画面には画像と音楽が出ない** —— そんなときは、下の **①〜⑤** をこの順でやってください。

| 順番 | やること | どこで | 確認する内容 |
|------|----------|--------|----------------|
| **①** | **Inngest で「どの step が中身を返していないか」を特定する** | [Inngest](https://app.inngest.com/) → **Runs** → 直近の「学校生成」の Run を開く | **step2-images** のログで `realImages` と `placeholderImages` の数字を見る。**step3-anthem-audio** のログに `step3: no audio URL` が出ていないか見る。 |
| **②** | **画像か校歌か、どちらを先に直すか決める** | ①の結果をメモ | `realImages: 0` かつ `placeholderImages: 7` → **画像**が全部失敗。`step3: no audio URL` あり → **校歌**が失敗。両方なら両方のログを追う。 |
| **③** | **Vercel のログで「なぜ」失敗しているかを見る** | Vercel ダッシュボード → **Logs**。該当 Run の実行時刻で検索 | **画像** → `Comet image` または `generate-school-image` で検索。**校歌** → `Suno` または `generate-audio` で検索。下の「2. 画像が出ない場合」「3. 校歌が出ない場合」の表の文言と照合する。 |
| **④** | **環境変数と Comet の契約を確認する** | Vercel → **Settings** → **Environment Variables**。Comet のダッシュボード | `COMET_API_KEY` が **Production** にチェックが入っているか。Comet のプランに**画像生成**と**Suno（音楽生成）**が含まれているか。キーが無効・期限切れになっていないか。[Comet_API_確認手順.md](./Comet_API_確認手順.md) の 1〜4 を実施。 |
| **⑤** | **必要なら API を直接叩いて試す** | ターミナルや Postman など | **画像**: `POST /api/generate-school-image` に `{ "prompt": "A simple red apple on white background", "imageType": "overview" }` を送り、`url` が placehold.co 以外で返るか。**校歌**: `POST /api/generate-audio` に `{ "lyrics": "テスト\n一行", "title": "Test", "style": "calm" }` を送り、`url` が返るか。本番 URL で試すと「本番だけの設定ミス」が分かる。 |

**ポイント:** Inngest は「step が例外で落ちなければ成功」と出すだけなので、**中身（画像 URL・音声 URL）が取れていなくても成功になる**ことがあります。①で step2 / step3 の**ログの中身**を見て、`realImages` や `step3: no audio URL` を確認するのが最初の一歩です。

---

## 1. Inngest の Run ログで「どこまで成功したか」を見る

### Inngest の画面での見方（スクショの状態から）

1. [Inngest Dashboard](https://app.inngest.com/) にログインする。
2. 左メニューの **Runs** をクリックする（いまのスクショの状態）。
3. 一覧から **確認したい Run**（例: 学校生成が Completed のもの）をクリックして開く。
4. 下に **Trace**（タイムライン）が出る。ここに **step0** → **step1-text-and-a...** → **step2-images** → **step3-anthem-audio** → **step4-save-kv** が並んでいる。
5. **各 step をクリック**すると、**右側の「Step Output」** にその step の**戻り値（JSON）** が表示される。
   - **step2-images** をクリック → Step Output に、画像 URL を差し込んだあとの学校データが出る。ここで `image_url` や `emblem_url` がすべて **`placehold.co`** なら、画像は 1 枚も実画像になっていない。
   - **step3-anthem-audio** をクリック → Step Output に、校歌を差し込んだあとの学校データが出る。`school_anthem` に **`audio_url` が無い**なら、校歌音声は取得できていない。
6. **`realImages` / `placeholderImages` の数値**や **`step3: no audio URL`** という文字は、サーバー（Vercel）の **console.log** で出しているため、**Inngest の Step Output には出ません**。これらを見るには **Vercel ダッシュボード → プロジェクト → Logs** を開き、この Run の実行時刻（例: 0:31〜0:37）でフィルタし、`step2` や `no audio` で検索する。

**まとめ:** Inngest では **Trace の step をクリック → 右の Step Output で戻り値（JSON）を確認**。画像は `image_url` が placehold.co か、校歌は `school_anthem.audio_url` があるかで判断できる。より細かいログ（realImages 数など）は **Vercel の Logs** で見る。

---

### 確認する内容（従来どおり）

- **step2-images** の結果で、すべての画像 URL が placehold.co → **画像 API 側の失敗**。
- **step3-anthem-audio** の結果で、`school_anthem.audio_url` が無い → **校歌（Suno）側の失敗**。
- `realImages: 0`, `placeholderImages: 7`, `step3: no audio URL` などの診断メッセージは **Vercel Logs** で確認。

**ポイント:** Inngest のログで「画像が全部プレースホルダー」か「校歌だけ失敗」かを切り分ける。

---

## 2. 画像が出ない場合（step2 で realImages: 0）

**Vercel → Logs** で、該当時刻あたりに次のいずれかが出ていないか検索する：

| ログに含まれる文言 | 意味 | 対処 |
|--------------------|------|------|
| `Comet image API returned HTML` | Comet が HTML（エラーページ）を返した | 認証エラー・未契約・エンドポイント不一致の可能性。[Comet_API_確認手順.md](./Comet_API_確認手順.md) の 1〜3 を確認。 |
| `Comet image API non-OK:` | 4xx/5xx が返った | Comet ダッシュボードでエラー内容・レート制限を確認。**404**「models/xxx は見つからない」→ **COMET_IMAGE_MODEL** で利用可能なモデルを指定。**400「マルチモーダル出力はサポートされていません」** → そのモデルは画像出力非対応。Comet のドキュメントで**画像生成対応**のモデル ID を確認し **COMET_IMAGE_MODEL** に設定。 |
| `Comet image API response not JSON` | レスポンスが JSON ではなかった | 上と同様、Comet 側の返却を確認。 |
| `[Comet image] 200 OK but no image` | 200 だが画像データが無い | 安全フィルタでブロックされている可能性。プロンプト内容や `COMET_IMAGE_MODEL` の変更を検討。 |

- **REPLICATE_API_TOKEN** を設定している場合は、画像は **Replicate** 経由になる。その場合は Comet のログは出ず、Replicate 側のエラーを疑う。
- 環境変数で **COMET_API_KEY** と **REPLICATE_API_TOKEN** のどちらが設定されているか確認する（Replicate 優先）。

---

## 3. 校歌が出ない場合（step3 で no audio URL）

**Vercel → Logs** で、該当時刻あたりに次のいずれかが出ていないか検索する：

| ログに含まれる文言 | 意味 | 対処 |
|--------------------|------|------|
| `Suno submit returned HTML` / `Suno API が HTML を返しました` | Comet Suno が HTML を返した | [Comet_API_確認手順.md](./Comet_API_確認手順.md) の 1〜2。Suno 利用可否・API キーを確認。 |
| `Suno submit のレスポンスに task_id が含まれていません` | タスク受付のレスポンス形式が想定と違う | Vercel Logs で **`[Suno Submit] raw response`** と **`top-level keys`** を検索し、実際のキー名を確認。Comet の Suno API ドキュメントで正しいフィールド名（task_id / id / taskId / result.task_id 等）を確認し、コードでそのキーを参照する。 |
| `Suno poll timeout` | ポーリングで完了までに至らなかった | Suno 側の遅延・障害。時間をおいて再試行。必要ならポーリングのタイムアウトを延長。 |
| `Suno task failed` | タスクが失敗扱いで返った | ログの生レスポンスを確認し、Comet のエラー内容に合わせて対処。 |

---

## 4. まとめ

1. **Inngest の Run** で `step2` / `step3` のログを見て、**画像が全部プレースホルダーか**・**校歌の URL が取れていないか**を判断する。
2. **Vercel Logs** で上記のキーワードを検索し、Comet / Replicate / Suno のどの段階で失敗しているかを確認する。
3. 認証・プラン・レート制限は [Comet_API_確認手順.md](./Comet_API_確認手順.md) のチェックリストで確認する。

原因が分かったら、該当する API の設定・契約・プロンプトを見直し、再度「学校生成」を実行してください。

- **検証項目や Gemini に聞くこと**をまとめた一覧は [画像・校歌を動かすための検証と調べること.md](./画像・校歌を動かすための検証と調べること.md) を参照。
- **ローカルは動くのに本番だけ動かない**ときは [Cursorには見えない落とし穴_デプロイとダッシュボード.md](./Cursorには見えない落とし穴_デプロイとダッシュボード.md)（Inngest Sync・環境変数・画像サイズ等）を確認。
