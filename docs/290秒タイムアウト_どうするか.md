# 290秒タイムアウト — どうしたらいいか

Inngest 経由でも **Step1 が呼ぶ `/api/generate-school` は Vercel 上で動く**ため、**290秒のルールはそのまま効いています**。  
「どうしたらいいか」を優先度でまとめます。

---

## ⚠️ 「画像・校歌が出ない」と 290秒は**別問題**

- **290秒**で影響するのは **Step1（テキスト）** だけ。時間切れだと**テキストがモック**になる。
- **画像**は Step2（別枠・約36秒で完了）、**校歌**は Step3（別枠・約2秒で完了）で、それぞれ**時間切れでは落ちていません**。
- ログでは **校歌**: Comet の Suno API が **HTML を返して** `JSON.parse` でエラー → `audio_url` が付かず「校歌が出ていない」と表示される。
- 画像も Comet の画像 API がエラー or プレースホルダーを返すと、`placehold.co` のままになる。
- **対策**: テキストをシンプルにしても画像・校歌は直らない。**Comet の API キー・Suno/画像の利用可否・レート制限**を確認する必要がある。

---

## すぐできること（おすすめ順）

### 1. いったん「様子見」する（推奨）

- 校歌の「HTML が返って JSON パースで落ちる」問題は **コード側で対策済み**（再デプロイ後はエラーにならずフォールバックする想定）。
- 画像も Comet が HTML を返したときの扱いを修正済み。
- **290秒でモックになるのは「重い地域・長い応答のときだけ」**なので、まずは再デプロイして成功率がどう変わるか見るのがおすすめ。

**やること**: 特になし。デプロイして数回「学校生成」を試し、テキスト・画像・校歌がどれくらい出るか確認する。

---

### 2. 290秒を「ギリギリまで」使う（数秒だけ延ばす）

- いまは 300 秒の手前で **290 秒**で打ち切っている。
- **295 秒**などに変更すると、わずかだが「もう少し待つ」余裕が出る（根本解決ではない）。

**やること**: `app/api/generate-school/route.ts` の `AI_TIMEOUT_MS = 290_000` を `295_000` などに変更。  
※ 300 秒ぴったりにすると Vercel 側で 504 になる可能性があるので、295 秒前後が無難。

---

### 3. テキスト生成を「軽く」して 290 秒以内に収める

- プロンプトや地域リサーチの文字数が長いと、AI の応答が遅くなり 290 秒に届きやすい。
- **実施済み（約2/3に軽量化）**：地域リサーチ 1500→**1000字**、max_tokens 8192→**5500**、userPrompt の長い例・「100個連想」リスト削除、合格基準の数値・文字数を約2/3に緩和。
- さらに短くする場合は `generate-school/route.ts` の systemPrompt 内の画像プロンプト例を削ることも可能。

---

## あとで検討すること（工数あり）

### 4. 学校テキストを「2本に分割」して並列実行する

- **現状**: 学校テキストを **1本の API** で 290 秒までにまとめて取得。
- **案**: 「コア」（校名・概要・校長・校訓・校歌・銅像・制服・歴史的建物）と「拡張」（行事・部活・施設・教員）の **2本の API** に分け、**並列**で呼ぶ。
- それぞれ別の 300 秒枠になるので、1本が 290 秒を超えても、もう1本は完了していればマージして表示できる。
- **注意**: 設計・実装が重い。校名や地域の一貫性をどう保つかも要検討。

**やること**: 設計が決まってから、`generate-school` を分割するか、別エンドポイントを用意するか検討。

---

## まとめ

| 優先度 | やること | 効果 |
|--------|----------|------|
| 1 | **様子見**（校歌・画像の修正をデプロイして確認） | 既存の不具合が減り、成功率が上がる可能性が高い |
| 2 | 290 → 295 秒に変更 | 数秒だけ余裕が出る |
| 3 | 地域リサーチ短縮などでテキスト生成を軽くする | 290 秒以内に収まりやすくなる |
| 4 | 学校テキストを2本に分割（将来案） | 長時間かかっても完了しやすくなる（要設計） |

**まずは 1 の「様子見」＋ 必要なら 2 の「295秒」** から始めるのがおすすめです。
