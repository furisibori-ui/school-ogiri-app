# 🎵 Suno AI 音楽生成機能のセットアップ

## 📋 概要

CometAPI経由でSuno AIを使い、校歌を自動生成します。

- **使用AI**: Suno AI v5
- **料金**: 約¥21/曲
- **生成時間**: 約60秒を指定（style に "about 60 seconds"、リクエストに duration: 60 を付与）
- **歌詞**: 音楽生成には**1番のみ**を送る（短くして確実に収める）。**サイトに掲載する歌詞は3番まで全文**を表示（APIから返る歌詞をそのまま表示）

---

## 🚀 セットアップ手順

### ステップ1️⃣：CometAPI アカウント作成

1. **https://www.cometapi.com/** にアクセス
2. **「Sign Up」** をクリック
3. メールアドレスとパスワードで登録

### ステップ2️⃣：APIキー取得

1. ログイン後、**ダッシュボード** にアクセス
2. **「API Keys」** を選択
3. **「Create New Key」** をクリック
4. キー名を入力（例：`school-ogiri-app`）
5. **「Create」** をクリック
6. **表示されたAPIキーをコピー**（`sk-...`で始まる）

### ステップ3️⃣：環境変数に設定

#### ローカル環境

`.env.local` ファイルに追加：

```bash
COMET_API_KEY=sk-abc123...
```

#### Vercel環境

1. https://vercel.com/dashboard にアクセス
2. プロジェクトを選択
3. 「Settings」→「Environment Variables」
4. 「Add New」をクリック
5. 入力：
   - **Name**: `COMET_API_KEY`
   - **Value**: `sk-abc123...`（コピーしたキー）
   - **Environment**: 全部にチェック
6. 「Save」をクリック

### ステップ4️⃣：クレジットをチャージ

CometAPIは従量課金制です：

1. ダッシュボードで **「Billing」** をクリック
2. **「Add Credits」** をクリック
3. 金額を選択（最初は$5程度でOK）
4. クレジットカードで支払い

---

## 💰 料金について

### 1曲あたりのコスト

- **音楽生成**: $0.144/回（約¥21）
- **歌詞生成**: $0.02/回（約¥3）※今回は使わない
- **合計**: 約¥21/曲

### 月間コスト試算

| 生成回数 | 月間コスト |
|---------|-----------|
| 10回 | 約¥210 |
| 50回 | 約¥1,050 |
| 100回 | 約¥2,100 |

---

## 🎼 機能の仕様

### 入力

1. **歌詞**：Claude が生成した校歌の歌詞
2. **スタイル**：「荘厳な合唱曲風」「軍歌風」など
3. **タイトル**：校名

### 出力

- **音声ファイル**（MP3形式）
- **audio タグ**で再生可能

### プロンプト例

```
[Verse 1]
朝日輝く この地に
東京タワー仰ぎて 学び舎あり
誠実勤勉 我らの誇り
未来を拓く 若き力

[Chorus]
増上寺の 薫風に
希望を胸に 進みゆく
ああ 私立東京タワー学園
我らが母校 永遠に

Style: solemn choir, orchestral, Japanese school anthem, inspirational
```

---

## 🔒 セキュリティ

- APIキーはサーバーサイドのみで使用
- クライアントには露出しない
- 生成された音楽URLは一定期間で期限切れ

---

## ⚙️ 機能の有効化/無効化

環境変数が設定されていない場合、音声生成はスキップされます。

```typescript
// 環境変数なし → 音声なし
COMET_API_KEY=未設定
↓
校歌の歌詞のみ表示

// 環境変数あり → 音声あり
COMET_API_KEY=sk-abc123...
↓
音声プレーヤー表示 + 歌詞表示
```

---

## 🎨 生成される音楽の特徴

- **日本の学校らしい荘厳な雰囲気**
- **合唱＋オーケストラ**
- **地名・ランドマークに基づいた歌詞**
- **感動的なメロディー**

---

## 🐛 トラブルシューティング

### 音楽が生成されない

1. 環境変数が正しく設定されているか確認
2. CometAPIのクレジット残高を確認
3. Vercelを再デプロイ
4. ブラウザのコンソールでエラーを確認

### 生成に時間がかかる・295秒でも曲が間に合わない

- **295秒**は「学校データ（テキスト）を返すAPI」のタイムアウトです。**楽曲は別API**（`/api/generate-audio`）で生成されます。
- Suno AIの音楽生成は**30秒〜1分以上**かかることがあり、混雑時はさらに遅くなります。
- **Vercelの制限**: `generate-audio` は **限界ギリギリで300秒** まで待機するように設定済み（Proプランで有効）。Hobbyのままでは60秒が上限です。
- **対策**: **Vercel Pro** にすると、全APIを300秒まで延長しており、Sunoが遅くても待てます。
  2. 校歌は「歌詞だけ先行取得」して、**早めに楽曲生成を1本だけ開始**する仕様になっており、学校データと並列で走ります。それでも間に合わない場合は、上記の延長を検討してください。

### Suno以外で間に合う代替はある？

- **CometAPI** では現在 Suno で音楽生成しています。CometAPIに **TTS（テキスト読み上げ）** などの別チャネルがあれば、歌詞を「朗読」するだけなら **数秒〜十数秒** で返せますが、**曲ではなくなります**（校歌らしさは失われます）。
- **Suno より速い「作曲API」** を CometAPI が提供しているかは、[CometAPI のドキュメント](https://www.cometapi.com/docs) で確認してください。別の音楽生成モデルを利用できる場合は、コードで `generate-audio` のエンドポイントを差し替えることで対応可能です。

### 料金が心配

1. CometAPIダッシュボードで使用量を確認
2. 予算上限を設定
3. 環境変数を削除すれば音声生成は無効化されます

---

## 📞 参考リンク

- CometAPI: https://www.cometapi.com/
- Suno AI: https://suno.ai/
- APIドキュメント: https://www.cometapi.com/docs

---

Happy composing! 🎵✨
